<!-- 統一JavaScript功能 -->

<script>
    // 全域變數
    let sparkleCount = 0;

    // Mobile menu toggle
    function initMobileMenu() {
        const menuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');

        if (menuButton && mobileMenu) {
            menuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                if (!mobileMenu.classList.contains('hidden')) {
                    setTimeout(() => mobileMenu.classList.add('show'), 10);
                } else {
                    mobileMenu.classList.remove('show');
                }
            });
        }
    }

    // Back to top button
    function initBackToTop() {
        const backToTopButton = document.getElementById('back-to-top');

        if (backToTopButton) {
            const toggleBackToTopButton = () => {
                if (window.pageYOffset > 300) {
                    backToTopButton.classList.remove('opacity-0', 'invisible');
                    backToTopButton.classList.add('opacity-100');
                } else {
                    backToTopButton.classList.add('opacity-0', 'invisible');
                    backToTopButton.classList.remove('opacity-100');
                }
            };

            backToTopButton.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                backToTopButton.style.animation = 'scale-bounce 0.3s ease';
                setTimeout(() => backToTopButton.style.animation = '', 300);
            });

            window.addEventListener('scroll', toggleBackToTopButton);
            toggleBackToTopButton(); // 初始化
        }
    }

    // Intersection Observer for animations
    function initScrollAnimations() {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'slide-up 0.6s ease-out';
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        // 觀察各種元素
        document.querySelectorAll('.feature-card, .content-card, .content-section').forEach(element => {
            observer.observe(element);
        });
    }

    // Button feedback animations
    function initButtonAnimations() {
        document.querySelectorAll('.button-primary, .button-secondary').forEach(button => {
            button.addEventListener('click', function(e) {
                this.style.animation = 'bounce-soft 0.3s ease';
                setTimeout(() => this.style.animation = '', 300);
            });
        });
    }

    // 搜尋功能
    function initSearch() {
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const searchItems = document.querySelectorAll('[data-searchable]');

        if (searchInput && searchItems.length > 0) {
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                
                if (query === '') {
                    // 顯示所有項目
                    searchItems.forEach(item => {
                        item.style.display = '';
                        item.classList.remove('animate-fade-in');
                    });
                    return;
                }

                let visibleCount = 0;
                searchItems.forEach(item => {
                    const searchText = item.getAttribute('data-searchable').toLowerCase();
                    if (searchText.includes(query)) {
                        item.style.display = '';
                        item.classList.add('animate-fade-in');
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                        item.classList.remove('animate-fade-in');
                    }
                });

                // 更新搜尋結果提示
                if (searchResults) {
                    if (visibleCount === 0) {
                        searchResults.textContent = '未找到相關結果';
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.classList.add('hidden');
                    }
                }
            });
        }
    }

    // 標籤過濾功能
    function initTagFilter() {
        const tagButtons = document.querySelectorAll('[data-tag-filter]');
        const filterItems = document.querySelectorAll('[data-tags]');

        if (tagButtons.length > 0 && filterItems.length > 0) {
            tagButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const filterTag = this.getAttribute('data-tag-filter');
                    
                    // 更新按鈕狀態
                    tagButtons.forEach(btn => btn.classList.remove('bg-soft-accent-primary', 'text-soft-dark-primary'));
                    this.classList.add('bg-soft-accent-primary', 'text-soft-dark-primary');

                    // 過濾項目
                    filterItems.forEach(item => {
                        const itemTags = item.getAttribute('data-tags').split(',');
                        if (filterTag === 'all' || itemTags.includes(filterTag)) {
                            item.style.display = '';
                            item.classList.add('animate-fade-in');
                        } else {
                            item.style.display = 'none';
                            item.classList.remove('animate-fade-in');
                        }
                    });
                });
            });
        }
    }

    // 創建閃爍效果
    function createSparkle() {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.style.left = Math.random() * window.innerWidth + 'px';
        sparkle.style.top = Math.random() * window.innerHeight + 'px';
        sparkle.style.animationDelay = Math.random() * 2 + 's';
        document.body.appendChild(sparkle);

        setTimeout(() => {
            if (sparkle.parentNode) {
                sparkle.remove();
            }
        }, 2000);
    }

    // 滾動時的閃爍效果
    function initSparkleEffect() {
        window.addEventListener('scroll', () => {
            sparkleCount++;
            if (sparkleCount % 100 === 0) {
                createSparkle();
            }
        });
    }

    // 表單驗證
    function initFormValidation() {
        const forms = document.querySelectorAll('form[data-validate]');
        
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const requiredFields = this.querySelectorAll('[required]');
                let isValid = true;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                        field.classList.add('border-red-500');
                        
                        // 移除錯誤樣式
                        setTimeout(() => {
                            field.classList.remove('border-red-500');
                        }, 3000);
                    }
                });

                if (!isValid) {
                    e.preventDefault();
                    // 顯示錯誤消息
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
                    errorMsg.textContent = '請填寫所有必填欄位';
                    document.body.appendChild(errorMsg);

                    setTimeout(() => {
                        errorMsg.remove();
                    }, 3000);
                }
            });
        });
    }

    // 複製功能
    function initCopyFunction() {
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('copy-btn') || e.target.closest('.copy-btn')) {
                const btn = e.target.classList.contains('copy-btn') ? e.target : e.target.closest('.copy-btn');
                const targetId = btn.getAttribute('data-copy-target');
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    const textToCopy = targetElement.textContent || targetElement.value;
                    
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        // 顯示成功消息
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i>已複製';
                        btn.classList.add('bg-green-500');
                        
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('bg-green-500');
                        }, 2000);
                    });
                }
            }
        });
    }

    // 主要初始化函數
    function initializeApp() {
        initMobileMenu();
        initBackToTop();
        initScrollAnimations();
        initButtonAnimations();
        initSearch();
        initTagFilter();
        initSparkleEffect();
        initFormValidation();
        initCopyFunction();
        
        // 加載完成後的動畫
        document.body.classList.add('animate-fade-in');
    }

    // 當頁面加載完成時初始化
    document.addEventListener('DOMContentLoaded', initializeApp);

    // 處理頁面可見性變化
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            // 頁面重新可見時重新初始化某些功能
            initBackToTop();
        }
    });

    // 響應式處理
    window.addEventListener('resize', function() {
        // 在視窗大小改變時重新計算某些元素
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenu && window.innerWidth >= 768) {
            mobileMenu.classList.add('hidden');
            mobileMenu.classList.remove('show');
        }
    });

    // 錯誤處理
    window.addEventListener('error', function(e) {
        console.warn('頁面發生錯誤，但不影響基本功能:', e.error);
    });

    // 性能優化：防抖動函數
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // 節流函數
    function throttle(func, limit) {
        let inThrottle;
        return function() {
            const args = arguments;
            const context = this;
            if (!inThrottle) {
                func.apply(context, args);
                inThrottle = true;
                setTimeout(() => inThrottle = false, limit);
            }
        }
    }
</script>